(function(e,b){var k={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"},j="ongesturestart" in document.createElement("div");function h(l){var m=l.originalEvent.changedTouches[0];return e.extend(l,{type:k[l.type],which:1,pageX:m.pageX,pageY:m.pageY,screenX:m.screenX,screenY:m.screenY,clientX:m.clientX,clientY:m.clientY,isTouchEvent:true})}var d=e.ui.mouse.prototype,g=e.ui.mouse.prototype._mouseInit;d._mouseInit=function(){var l=this;l._touchActive=false;this.element.bind("touchstart."+this.widgetName,function(m){if(j&&m.originalEvent.touches.length>1){return}l._touchActive=true;return l._mouseDown(h(m))});var l=this;this._mouseMoveDelegate=function(m){if(j&&m.originalEvent.touches&&m.originalEvent.touches.length>1){return}if(l._touchActive){return l._mouseMove(h(m))}};this._mouseUpDelegate=function(m){if(l._touchActive){l._touchActive=false;return l._mouseUp(h(m))}};e(document).bind("touchmove."+this.widgetName,this._mouseMoveDelegate).bind("touchend."+this.widgetName,this._mouseUpDelegate);g.apply(this)};var c=function(m,l){return function(n){if(arguments.length===0){return l.apply(this)}else{m.apply(this,arguments)}}};var i={"0":{marginLeft:0,marginTop:0,filter:'progid:DXImageTransform.Microsoft.Matrix(M11=1, M12=0, M21=0, M22=1, SizingMethod="auto expand")'},"90":{marginLeft:-1,marginTop:1,filter:'progid:DXImageTransform.Microsoft.Matrix(M11=0, M12=-1, M21=1, M22=0, SizingMethod="auto expand")'},"180":{marginLeft:0,marginTop:0,filter:'progid:DXImageTransform.Microsoft.Matrix(M11=-1, M12=0, M21=0, M22=-1, SizingMethod="auto expand")'},"270":{marginLeft:-1,marginTop:1,filter:'progid:DXImageTransform.Microsoft.Matrix(M11=0, M12=1, M21=-1, M22=0, SizingMethod="auto expand")'}},a=function(){var r=document.createElement("modernizr"),m=r.style,l="Webkit Moz O ms",o=l.toLowerCase().split(" "),p=("transform "+o.join("Transform ")+"Transform").split(" ");for(var n in p){var q=p[n];if(!e.contains(q,"-")&&m[q]!==b){return false}}return true}();e.widget("ui.iviewer",e.ui.mouse,{widgetEventPrefix:"iviewer",options:{zoom:"fit",zoom_base:100,zoom_max:800,zoom_min:25,zoom_delta:1.4,zoom_animation:true,ui_disabled:false,mousewheel:true,update_on_resize:true,onZoom:jQuery.noop,onAfterZoom:jQuery.noop,onStartDrag:jQuery.noop,onDrag:jQuery.noop,onStopDrag:jQuery.noop,onMouseMove:jQuery.noop,onClick:jQuery.noop,onStartLoad:null,onFinishLoad:null,onErrorLoad:null},_create:function(){var n=this;this.dx=0;this.dy=0;this.img_object={};this.zoom_object={};this._angle=0;this.current_zoom=this.options.zoom;if(this.options.src===null){return}this.container=this.element;this._updateContainerInfo();this.container.css("overflow","hidden");if(this.options.update_on_resize==true){e(window).resize(function(){n.update()})}this.img_object=new e.ui.iviewer.ImageObject(this.options.zoom_animation);if(this.options.mousewheel){this.container.bind("mousewheel.iviewer",function(r,t){var q=(t>0)?1:-1,s=n.container.offset(),p={x:(r.pageX||r.originalEvent.pageX)-s.left,y:(r.pageY||r.originalEvent.pageX)-s.top};n.zoom_by(q,p);return false});if(j){var l=+new Date();var m,o;this.img_object.object().bind("touchstart",function(p){m=n.current_zoom;var q=p.originalEvent.touches,r;if(q.length==2){r=n.container.offset();o={x:(q[0].pageX+q[1].pageX)/2-r.left,y:(q[0].pageY+q[1].pageY)/2-r.top}}else{o=null}}).bind("gesturechange",function(q){var r=+new Date();if((r-l)<50){return}l=r;var p=m*q.originalEvent.scale;n.set_zoom(p,o);q.preventDefault()}).bind("gestureend",function(p){o=null})}}this.img_object.object().click(function(p){return n._click(p)}).prependTo(this.container);this.container.bind("mousemove",function(p){n._handleMouseMove(p)});this.loadImage(this.options.src);if(!this.options.ui_disabled){this.createui()}this._mouseInit()},destroy:function(){e.Widget.prototype.destroy.call(this);this._mouseDestroy();this.img_object.object().remove();this.container.off(".iviewer");this.container.css("overflow","")},_updateContainerInfo:function(){this.options.height=this.container.height();this.options.width=this.container.width()},update:function(){this._updateContainerInfo();this.setCoords(this.img_object.x(),this.img_object.y())},loadImage:function(m){this.current_zoom=this.options.zoom;var l=this;this._trigger("onStartLoad",0,m);this.container.addClass("iviewer_loading");this.img_object.load(m,function(){l._imageLoaded(m)},function(){l._trigger("onErrorLoad",0,m)})},_imageLoaded:function(l){this.container.removeClass("iviewer_loading");this.container.addClass("iviewer_cursor");if(this.options.zoom=="fit"){this.fit(true)}else{this.set_zoom(this.options.zoom,true)}this._trigger("onFinishLoad",0,l)},fit:function(n){var o=this.img_object.orig_width()/this.img_object.orig_height();var l=this.options.width/this.options.height;var m=(o>l);var p=0;if(m){p=this.options.width/this.img_object.orig_width()*100}else{p=this.options.height/this.img_object.orig_height()*100}this.set_zoom(p,n)},center:function(){this.setCoords(-Math.round((this.img_object.display_width()-this.options.width)/2),-Math.round((this.img_object.display_height()-this.options.height)/2))},moveTo:function(l,q){var n=l-Math.round(this.options.width/2);var m=q-Math.round(this.options.height/2);var p=this.img_object.x()-n;var o=this.img_object.y()-m;this.setCoords(p,o)},getContainerOffset:function(){return jQuery.extend({},this.container.offset())},setCoords:function(l,n){if(!this.img_object.loaded()){return}var m=this._correctCoords(l,n);this.img_object.x(m.x);this.img_object.y(m.y)},_correctCoords:function(l,m){l=parseInt(l,10);m=parseInt(m,10);if(m>0){m=0}if(l>0){l=0}if(m+this.img_object.display_height()<this.options.height){m=this.options.height-this.img_object.display_height()}if(l+this.img_object.display_width()<this.options.width){l=this.options.width-this.img_object.display_width()}if(this.img_object.display_width()<=this.options.width){l=-(this.img_object.display_width()-this.options.width)/2}if(this.img_object.display_height()<=this.options.height){m=-(this.img_object.display_height()-this.options.height)/2}return{x:l,y:m}},containerToImage:function(l,n){var m={x:l-this.img_object.x(),y:n-this.img_object.y()};m=this.img_object.toOriginalCoords(m);return{x:f.descaleValue(m.x,this.current_zoom),y:f.descaleValue(m.y,this.current_zoom)}},imageToContainer:function(l,n){var m={x:f.scaleValue(l,this.current_zoom),y:f.scaleValue(n,this.current_zoom)};return this.img_object.toRealCoords(m)},_getMouseCoords:function(m){var l=this.container.offset();coords=this.containerToImage(m.pageX-l.left,m.pageY-l.top);return coords},set_zoom:function(n,o,s){if(this._trigger("onZoom",0,n)==false){return}if(!this.img_object.loaded()){return}s=s||{x:Math.round(this.options.width/2),y:Math.round(this.options.height/2)};if(n<this.options.zoom_min){n=this.options.zoom_min}else{if(n>this.options.zoom_max){n=this.options.zoom_max}}if(this.current_zoom=="fit"){var r=s.x+Math.round(this.img_object.orig_width()/2);var p=s.y+Math.round(this.img_object.orig_height()/2);this.current_zoom=100}else{var r=-this.img_object.x()+s.x;var p=-this.img_object.y()+s.y}var m=f.scaleValue(this.img_object.orig_width(),n);var l=f.scaleValue(this.img_object.orig_height(),n);var t=f.scaleValue(f.descaleValue(r,this.current_zoom),n);var q=f.scaleValue(f.descaleValue(p,this.current_zoom),n);t=s.x-t;q=s.y-q;m=Math.floor(m);l=Math.floor(l);t=Math.floor(t);q=Math.floor(q);this.img_object.display_width(m);this.img_object.display_height(l);var u=this._correctCoords(t,q),v=this;this.img_object.setImageProps(m,l,u.x,u.y,o,function(){v._trigger("onAfterZoom",0,n)});this.current_zoom=n;this.update_status()},zoom_by:function(p,o){var n=this.find_closest_zoom_rate(this.current_zoom);var l=n+p;var m=this.options.zoom_base*Math.pow(this.options.zoom_delta,l);if(p>0&&m<this.current_zoom){m*=this.options.zoom_delta}if(p<0&&m>this.current_zoom){m/=this.options.zoom_delta}this.set_zoom(m,b,o)},angle:function(m,l){if(arguments.length===0){return this.img_object.angle()}if(m<-270||m>270||m%90!==0){return}if(!l){m+=this.img_object.angle()}if(m<0){m+=360}if(m>=360){m-=360}if(m===this.img_object.angle()){return}this.img_object.angle(m);this.center();this._trigger("angle",0,{angle:this.img_object.angle()})},find_closest_zoom_rate:function(o){if(o==this.options.zoom_base){return 0}function r(t,s){return t/s}function p(t,s){return t*s}var n=(o>this.options.zoom_base)?p:r;var q=(o>this.options.zoom_base)?1:-1;var l=this.options.zoom_delta;var m=1;while(Math.abs(n(this.options.zoom_base,Math.pow(l,m))-o)>Math.abs(n(this.options.zoom_base,Math.pow(l,m+1))-o)){m++}return q*m},update_status:function(){if(!this.options.ui_disabled){var l=Math.round(100*this.img_object.display_height()/this.img_object.orig_height());if(l){this.zoom_object.html(l+"%")}}},info:function(m,l){if(!m){return}switch(m){case"orig_width":case"orig_height":if(l){return(this.img_object.angle()%180===0?this.img_object[m]():m==="orig_width"?this.img_object.orig_height():this.img_object.orig_width())}else{return this.img_object[m]()}case"display_width":case"display_height":case"angle":return this.img_object[m]();case"zoom":return this.current_zoom;case"src":return this.img_object.object().attr("src");case"coords":return{x:this.img_object.x(),y:this.img_object.y()}}},_mouseStart:function(l){e.ui.mouse.prototype._mouseStart.call(this,l);if(this._trigger("onStartDrag",0,this._getMouseCoords(l))===false){return false}this.container.addClass("iviewer_drag_cursor");this._dragInitialized=!(l.originalEvent.changedTouches&&l.originalEvent.changedTouches.length==1);this.dx=l.pageX-this.img_object.x();this.dy=l.pageY-this.img_object.y();return true},_mouseCapture:function(l){return true},_handleMouseMove:function(l){this._trigger("onMouseMove",l,this._getMouseCoords(l))},_mouseDrag:function(n){e.ui.mouse.prototype._mouseDrag.call(this,n);if(!this._dragInitialized){this.dx=n.pageX-this.img_object.x();this.dy=n.pageY-this.img_object.y();this._dragInitialized=true}var l=n.pageY-this.dy;var m=n.pageX-this.dx;this.setCoords(m,l);this._trigger("onDrag",n,this._getMouseCoords(n));return false},_mouseStop:function(l){e.ui.mouse.prototype._mouseStop.call(this,l);this.container.removeClass("iviewer_drag_cursor");this._trigger("onStopDrag",0,this._getMouseCoords(l))},_click:function(l){this._trigger("onClick",0,this._getMouseCoords(l))},createui:function(){var l=this;e("<div>",{"class":"iviewer_zoom_in iviewer_common iviewer_button"}).bind("mousedown touchstart",function(){l.zoom_by(1);return false}).appendTo(this.container);e("<div>",{"class":"iviewer_zoom_out iviewer_common iviewer_button"}).bind("mousedown touchstart",function(){l.zoom_by(-1);return false}).appendTo(this.container);e("<div>",{"class":"iviewer_zoom_zero iviewer_common iviewer_button"}).bind("mousedown touchstart",function(){l.set_zoom(100);return false}).appendTo(this.container);e("<div>",{"class":"iviewer_zoom_fit iviewer_common iviewer_button"}).bind("mousedown touchstart",function(){l.fit(this);return false}).appendTo(this.container);this.zoom_object=e("<div>").addClass("iviewer_zoom_status iviewer_common").appendTo(this.container);e("<div>",{"class":"iviewer_rotate_left iviewer_common iviewer_button"}).bind("mousedown touchstart",function(){l.angle(-90);return false}).appendTo(this.container);e("<div>",{"class":"iviewer_rotate_right iviewer_common iviewer_button"}).bind("mousedown touchstart",function(){l.angle(90);return false}).appendTo(this.container);this.update_status()}});e.ui.iviewer.ImageObject=function(l){this._img=e("<img>").css({position:"absolute",top:"0px",left:"0px"});this._loaded=false;this._swapDimensions=false;this._do_anim=l||false;this.x(0,true);this.y(0,true);this.angle(0)};(function(){this._reset=function(l,m){this._angle=0;this._swapDimensions=false;this.x(0);this.y(0);this.orig_width(l);this.orig_height(m);this.display_width(l);this.display_height(m)};this.loaded=function(){return this._loaded};this.load=function(p,o,n){var m=this;o=o||jQuery.noop;this._loaded=false;var l=new Image();l.onload=function(){m._loaded=true;m._reset(this.width,this.height);m._img.removeAttr("width").removeAttr("height").removeAttr("style").css({position:"absolute",top:"0px",left:"0px",maxWidth:"none"});m._img[0].src=p;o()};l.onerror=n;setTimeout(function(){l.src=p},0);this.angle(0)};this._dimension=function(n,m){var o="_"+n+"_"+m,l="_"+n+"_"+(m==="height"?"width":"height");return c(function(p){this[this._swapDimensions?o:l]=p},function(){return this[this._swapDimensions?o:l]})};this.display_width=this._dimension("display","width"),this.display_height=this._dimension("display","height"),this.display_diff=function(){return Math.floor(this.display_width()-this.display_height())};this.orig_width=this._dimension("orig","width"),this.orig_height=this._dimension("orig","height"),this.x=c(function(m,l){this._x=m;if(!l){this._finishAnimation();this._img.css("left",this._x+(this._swapDimensions?this.display_diff()/2:0)+"px")}},function(){return this._x});this.y=c(function(m,l){this._y=m;if(!l){this._finishAnimation();this._img.css("top",this._y-(this._swapDimensions?this.display_diff()/2:0)+"px")}},function(){return this._y});this.angle=c(function(o){var n=this._swapDimensions;this._angle=o;this._swapDimensions=o%180!==0;if(n!==this._swapDimensions){var p=this._swapDimensions?-1:1;this.x(this.x()-p*this.display_diff()/2,true);this.y(this.y()+p*this.display_diff()/2,true)}var l="rotate("+o+"deg)",m=this._img;jQuery.each(["","-webkit-","-moz-","-o-","-ms-"],function(q,r){m.css(r+"transform",l)});if(a){jQuery.each(["-ms-",""],function(q,r){m.css(r+"filter",i[o].filter)});m.css({marginLeft:i[o].marginLeft*this.display_diff()/2,marginTop:i[o].marginTop*this.display_diff()/2})}},function(){return this._angle});this.toOriginalCoords=function(l){switch(this.angle()){case 0:return{x:l.x,y:l.y};case 90:return{x:l.y,y:this.display_width()-l.x};case 180:return{x:this.display_width()-l.x,y:this.display_height()-l.y};case 270:return{x:this.display_height()-l.y,y:l.x}}};this.toRealCoords=function(l){switch(this.angle()){case 0:return{x:this.x()+l.x,y:this.y()+l.y};case 90:return{x:this.x()+this.display_width()-l.y,y:this.y()+l.x};case 180:return{x:this.x()+this.display_width()-l.x,y:this.y()+this.display_height()-l.y};case 270:return{x:this.x()+l.y,y:this.y()+this.display_height()-l.x}}};this.object=c(jQuery.noop,function(){return this._img});this.setImageProps=function(u,q,z,v,o,l){l=l||jQuery.noop;this.display_width(u);this.display_height(q);this.x(z,true);this.y(v,true);var A=this._swapDimensions?q:u;var s=this._swapDimensions?u:q;var p={width:A,height:s,top:v-(this._swapDimensions?this.display_diff()/2:0)+"px",left:z+(this._swapDimensions?this.display_diff()/2:0)+"px"};if(a){jQuery.extend(p,{marginLeft:i[this.angle()].marginLeft*this.display_diff()/2,marginTop:i[this.angle()].marginTop*this.display_diff()/2})}var B=this._swapDimensions,r=this._img;if(a&&B){var m=this._img.width(),t=this._img.height(),n=p.height-m;iedw=p.width-t;delete p.width;delete p.height}if(this._do_anim&&!o){this._img.stop(true).animate(p,{duration:200,complete:l,step:function(w,y){if(a&&B&&(y.prop==="top")){var x=(w-y.start)/(y.end-y.start);r.height(m+n*x);r.width(t+iedw*x);r.css("top",w)}}})}else{this._img.css(p);setTimeout(l,0)}};this._finishAnimation=function(){this._img.stop(true,true)}}).apply(e.ui.iviewer.ImageObject.prototype);var f={scaleValue:function(m,l){return m*l/100},descaleValue:function(m,l){return m*100/l}}})(jQuery,undefined);